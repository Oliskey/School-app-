-- Row Level Security (RLS) Policies for Production
-- Run this in Supabase SQL Editor to secure your database

-- ============================================
-- ENABLE RLS ON ALL TABLES
-- ============================================
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE teachers ENABLE ROW LEVEL SECURITY;
ALTER TABLE parents ENABLE ROW LEVEL SECURITY;
ALTER TABLE notices ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_fees ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_attendance ENABLE ROW LEVEL SECURITY;
ALTER TABLE assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE classes ENABLE ROW LEVEL SECURITY;
ALTER TABLE timetable ENABLE ROW LEVEL SECURITY;
ALTER TABLE teacher_subjects ENABLE ROW LEVEL SECURITY;
ALTER TABLE teacher_classes ENABLE ROW LEVEL SECURITY;
ALTER TABLE parent_children ENABLE ROW LEVEL SECURITY;

-- ============================================
-- STUDENTS TABLE POLICIES
-- ============================================

-- Admin can do everything with students
CREATE POLICY "Admin full access to students" ON students
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- Students can view their own data
CREATE POLICY "Students view own data" ON students
    FOR SELECT
    USING (
        auth.uid()::text = id::text
    );

-- Teachers can view students in their classes
CREATE POLICY "Teachers view class students" ON students
    FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM teacher_classes tc
            JOIN teachers t ON t.id = tc.teacher_id
            WHERE t.id::text = auth.uid()::text
            AND tc.class_name = (students.grade::text || students.section)
        )
    );

-- Parents can view their children
CREATE POLICY "Parents view own children" ON students
    FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM parent_children pc
            JOIN parents p ON p.id = pc.parent_id
            WHERE p.id::text = auth.uid()::text
            AND pc.student_id = students.id
        )
    );

-- ============================================
-- TEACHERS TABLE POLICIES
-- ============================================

-- Admin full access
CREATE POLICY "Admin full access to teachers" ON teachers
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- All authenticated users can view teachers (for timetable, etc)
CREATE POLICY "All users view teachers" ON teachers
    FOR SELECT
    USING (auth.role() = 'authenticated');

-- Teachers can update their own data
CREATE POLICY "Teachers update own data" ON teachers
    FOR UPDATE
    USING (auth.uid()::text = id::text);

-- ============================================
-- PARENTS TABLE POLICIES
-- ============================================

-- Admin full access
CREATE POLICY "Admin full access to parents" ON parents
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- Parents can view their own data
CREATE POLICY "Parents view own data" ON parents
    FOR SELECT
    USING (auth.uid()::text = id::text);

-- Teachers can view parents of their students
CREATE POLICY "Teachers view student parents" ON parents
    FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM parent_children pc
            JOIN students s ON s.id = pc.student_id
            JOIN teacher_classes tc ON tc.class_name = (s.grade::text || s.section)
            JOIN teachers t ON t.id = tc.teacher_id
            WHERE t.id::text = auth.uid()::text
            AND pc.parent_id = parents.id
        )
    );

-- ============================================
-- NOTICES TABLE POLICIES
-- ============================================

-- Admin full access
CREATE POLICY "Admin full access to notices" ON notices
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- All authenticated users can view notices relevant to them
CREATE POLICY "Users view relevant notices" ON notices
    FOR SELECT
    USING (
        auth.role() = 'authenticated' AND (
            audience @> '["all"]'::jsonb OR
            (audience @> '["students"]'::jsonb AND EXISTS (
                SELECT 1 FROM students WHERE id::text = auth.uid()::text
            )) OR
            (audience @> '["teachers"]'::jsonb AND EXISTS (
                SELECT 1 FROM teachers WHERE id::text = auth.uid()::text
            )) OR
            (audience @> '["parents"]'::jsonb AND EXISTS (
                SELECT 1 FROM parents WHERE id::text = auth.uid()::text
            ))
        )
    );

-- ============================================
-- STUDENT FEES POLICIES
-- ============================================

-- Admin full access
CREATE POLICY "Admin full access to fees" ON student_fees
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- Students can view their own fees
CREATE POLICY "Students view own fees" ON student_fees
    FOR SELECT
    USING (student_id::text = auth.uid()::text);

-- Parents can view their children's fees
CREATE POLICY "Parents view children fees" ON student_fees
    FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM parent_children pc
            JOIN parents p ON p.id = pc.parent_id
            WHERE p.id::text = auth.uid()::text
            AND pc.student_id = student_fees.student_id
        )
    );

-- ============================================
-- ATTENDANCE POLICIES
-- ============================================

-- Admin full access
CREATE POLICY "Admin full access to attendance" ON student_attendance
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- Teachers can manage attendance for their classes
CREATE POLICY "Teachers manage class attendance" ON student_attendance
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM teacher_classes tc
            JOIN teachers t ON t.id = tc.teacher_id
            WHERE t.id::text = auth.uid()::text
            AND tc.class_name = student_attendance.class_name
        )
    );

-- Students can view their own attendance
CREATE POLICY "Students view own attendance" ON student_attendance
    FOR SELECT
    USING (student_id::text = auth.uid()::text);

-- Parents can view their children's attendance
CREATE POLICY "Parents view children attendance" ON student_attendance
    FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM parent_children pc
            JOIN parents p ON p.id = pc.parent_id
            WHERE p.id::text = auth.uid()::text
            AND pc.student_id = student_attendance.student_id
        )
    );

-- ============================================
-- ASSIGNMENTS POLICIES
-- ============================================

-- Admin full access
CREATE POLICY "Admin full access to assignments" ON assignments
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- Teachers can manage assignments for their classes
CREATE POLICY "Teachers manage class assignments" ON assignments
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM teacher_classes tc
            JOIN teachers t ON t.id = tc.teacher_id
            WHERE t.id::text = auth.uid()::text
            AND tc.class_name = assignments.class_name
        )
    );

-- Students can view assignments for their class
CREATE POLICY "Students view class assignments" ON assignments
    FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM students s
            WHERE s.id::text = auth.uid()::text
            AND (s.grade::text || s.section) = assignments.class_name
        )
    );

-- ============================================
-- READ-ONLY TABLES (Everyone can view)
-- ============================================

-- Classes table
CREATE POLICY "All users view classes" ON classes
    FOR SELECT
    USING (auth.role() = 'authenticated');

CREATE POLICY "Admin manage classes" ON classes
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- Timetable
CREATE POLICY "All users view timetable" ON timetable
    FOR SELECT
    USING (auth.role() = 'authenticated');

CREATE POLICY "Admin manage timetable" ON timetable
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- ============================================
-- JUNCTION TABLES
-- ============================================

-- Teacher subjects
CREATE POLICY "All users view teacher subjects" ON teacher_subjects
    FOR SELECT
    USING (auth.role() = 'authenticated');

CREATE POLICY "Admin manage teacher subjects" ON teacher_subjects
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- Teacher classes
CREATE POLICY "All users view teacher classes" ON teacher_classes
    FOR SELECT
    USING (auth.role() = 'authenticated');

CREATE POLICY "Admin manage teacher classes" ON teacher_classes
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- Parent children
CREATE POLICY "Users view relevant parent-child links" ON parent_children
    FOR SELECT
    USING (
        auth.role() = 'authenticated' AND (
            -- Admin sees all
            EXISTS (
                SELECT 1 FROM auth.users
                WHERE auth.uid() = id 
                AND raw_user_meta_data->>'role' = 'admin'
            ) OR
            -- Parent sees own children
            parent_id::text = auth.uid()::text OR
            -- Teachers see their students' parents
            EXISTS (
                SELECT 1 FROM students s
                JOIN teacher_classes tc ON tc.class_name = (s.grade::text || s.section)
                JOIN teachers t ON t.id = tc.teacher_id
                WHERE t.id::text = auth.uid()::text
                AND s.id = parent_children.student_id
            )
        )
    );

CREATE POLICY "Admin manage parent-child links" ON parent_children
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id 
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );

-- ============================================
-- VERIFICATION
-- ============================================

-- Check which policies are active
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual 
FROM pg_policies 
WHERE schemaname = 'public'
ORDER BY tablename, policyname;

-- Success message
SELECT 'RLS policies created successfully!' as status,
       COUNT(*) as total_policies
FROM pg_policies 
WHERE schemaname = 'public';
