-- Complete Demo Accounts Setup
-- Run this in Supabase SQL Editor to add all demo accounts for quick login
-- Includes: Admin, Teacher, Parent, and Student

-- ============================================
-- 1. Add email column to students table (if not exists)
-- ============================================
ALTER TABLE students 
ADD COLUMN IF NOT EXISTS email TEXT;

-- ============================================
-- 2. Update existing students with emails
-- ============================================
UPDATE students 
SET email = LOWER(REPLACE(name, ' ', '.')) || '@student.school.com'
WHERE email IS NULL;

-- ============================================
-- 3. Clean up existing demo accounts
-- ============================================
-- Remove old demo records
DELETE FROM student_fees WHERE student_id IN (SELECT id FROM students WHERE email = 'student@school.com');
DELETE FROM parent_children WHERE student_id IN (SELECT id FROM students WHERE email = 'student@school.com');
DELETE FROM parent_children WHERE parent_id IN (SELECT id FROM parents WHERE email = 'parent@school.com');
DELETE FROM teacher_subjects WHERE teacher_id IN (SELECT id FROM teachers WHERE email = 'teacher@school.com');
DELETE FROM teacher_classes WHERE teacher_id IN (SELECT id FROM teachers WHERE email = 'teacher@school.com');
DELETE FROM students WHERE email = 'student@school.com';
DELETE FROM teachers WHERE email = 'teacher@school.com';
DELETE FROM parents WHERE email = 'parent@school.com';

-- ============================================
-- 4. Add DEMO STUDENT (student@school.com)
-- ============================================
INSERT INTO students (name, email, grade, section, department, birthday, avatar_url, attendance_status) 
VALUES ('Demo Student', 'student@school.com', 10, 'A', 'Science', '2010-01-15', 'https://i.pravatar.cc/150?img=1', 'Present');

-- Add fee for demo student
DO $$
DECLARE
    demo_student_id INTEGER;
BEGIN
    SELECT id INTO demo_student_id FROM students WHERE email = 'student@school.com';
    
    IF demo_student_id IS NOT NULL THEN
        INSERT INTO student_fees (student_id, total_fee, paid_amount, status, due_date) 
        VALUES (demo_student_id, 150000, 75000, 'Unpaid', CURRENT_DATE + INTERVAL '10 days');
    END IF;
END $$;

-- ============================================
-- 5. Add DEMO TEACHER (teacher@school.com)
-- ============================================
INSERT INTO teachers (name, email, phone, avatar_url, status) 
VALUES ('Demo Teacher', 'teacher@school.com', '+234-800-000-0001', 'https://i.pravatar.cc/150?img=11', 'Active');

-- Add subjects for demo teacher
DO $$
DECLARE
    demo_teacher_id INTEGER;
BEGIN
    SELECT id INTO demo_teacher_id FROM teachers WHERE email = 'teacher@school.com';
    
    IF demo_teacher_id IS NOT NULL THEN
        -- Add subjects
        INSERT INTO teacher_subjects (teacher_id, subject) 
        VALUES 
            (demo_teacher_id, 'Mathematics'),
            (demo_teacher_id, 'Physics');
        
        -- Add classes
        INSERT INTO teacher_classes (teacher_id, class_name) 
        VALUES 
            (demo_teacher_id, '10A'),
            (demo_teacher_id, '11A');
    END IF;
END $$;

-- ============================================
-- 6. Add DEMO PARENT (parent@school.com)
-- ============================================
INSERT INTO parents (name, email, phone, avatar_url) 
VALUES ('Demo Parent', 'parent@school.com', '+234-800-000-0002', 'https://i.pravatar.cc/150?img=21');

-- Link demo parent to demo student
DO $$
DECLARE
    demo_parent_id INTEGER;
    demo_student_id INTEGER;
BEGIN
    SELECT id INTO demo_parent_id FROM parents WHERE email = 'parent@school.com';
    SELECT id INTO demo_student_id FROM students WHERE email = 'student@school.com';
    
    IF demo_parent_id IS NOT NULL AND demo_student_id IS NOT NULL THEN
        INSERT INTO parent_children (parent_id, student_id) 
        VALUES (demo_parent_id, demo_student_id);
    END IF;
END $$;

-- ============================================
-- 7. Add DEMO ADMIN (admin@school.com)
-- ============================================
-- Note: Admins might be in a different table or just authenticated via Supabase Auth
-- If you have an 'admins' or 'users' table, add it here
-- For now, admin login will use the fallback in the code

-- Check if you have an admins/users table and uncomment this if needed:
-- INSERT INTO admins (name, email, role, avatar_url) 
-- VALUES ('Demo Admin', 'admin@school.com', 'Administrator', 'https://i.pravatar.cc/150?img=31');

-- ============================================
-- 8. Verification - Check All Demo Accounts
-- ============================================

-- Check Demo Student
SELECT 'DEMO STUDENT' as account_type, 
    s.id, s.name, s.email, s.grade, s.section,
    COALESCE(sf.total_fee, 0) as total_fee,
    COALESCE(sf.paid_amount, 0) as paid_amount,
    COALESCE(sf.status, 'No Fee') as fee_status
FROM students s
LEFT JOIN student_fees sf ON s.id = sf.student_id
WHERE s.email = 'student@school.com';

-- Check Demo Teacher
SELECT 'DEMO TEACHER' as account_type,
    t.id, t.name, t.email, t.phone,
    ARRAY_AGG(DISTINCT ts.subject) FILTER (WHERE ts.subject IS NOT NULL) as subjects,
    ARRAY_AGG(DISTINCT tc.class_name) FILTER (WHERE tc.class_name IS NOT NULL) as classes
FROM teachers t
LEFT JOIN teacher_subjects ts ON t.id = ts.teacher_id
LEFT JOIN teacher_classes tc ON t.id = tc.teacher_id
WHERE t.email = 'teacher@school.com'
GROUP BY t.id, t.name, t.email, t.phone;

-- Check Demo Parent
SELECT 'DEMO PARENT' as account_type,
    p.id, p.name, p.email, p.phone,
    ARRAY_AGG(s.name) FILTER (WHERE s.name IS NOT NULL) as children
FROM parents p
LEFT JOIN parent_children pc ON p.id = pc.parent_id
LEFT JOIN students s ON pc.student_id = s.id
WHERE p.email = 'parent@school.com'
GROUP BY p.id, p.name, p.email, p.phone;

-- Summary
SELECT 
    'SUMMARY' as info,
    (SELECT COUNT(*) FROM students WHERE email = 'student@school.com') as student_created,
    (SELECT COUNT(*) FROM teachers WHERE email = 'teacher@school.com') as teacher_created,
    (SELECT COUNT(*) FROM parents WHERE email = 'parent@school.com') as parent_created,
    (SELECT COUNT(*) FROM student_fees WHERE student_id IN (SELECT id FROM students WHERE email = 'student@school.com')) as student_fee_created;

-- Expected Results:
-- âœ… Demo Student exists with fee record
-- âœ… Demo Teacher exists with subjects (Mathematics, Physics) and classes (10A, 11A)
-- âœ… Demo Parent exists and is linked to Demo Student
-- âœ… Summary should show 1 for each account type
-- If you see all of these, ALL DEMO ACCOUNTS are ready! ðŸŽ‰
