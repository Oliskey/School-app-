-- Complete Fix: Add Email Column, Demo Student, and Fee Record
-- Run this in Supabase SQL Editor to fix student authentication
-- This adds the missing email column and creates a demo student for quick login

-- ============================================
-- 1. Add email column to students table
-- ============================================
ALTER TABLE students 
ADD COLUMN IF NOT EXISTS email TEXT;

-- ============================================
-- 2. Update existing students with demo emails
-- ============================================
-- This gives all existing students an email based on their name
UPDATE students 
SET email = LOWER(REPLACE(name, ' ', '.')) || '@student.school.com'
WHERE email IS NULL;

-- ============================================
-- 3. Clean up any existing demo student
-- ============================================
DELETE FROM student_fees WHERE student_id IN (SELECT id FROM students WHERE email = 'student@school.com');
DELETE FROM students WHERE email = 'student@school.com';

-- ============================================
-- 4. Add the demo student for quick login
-- ============================================
INSERT INTO students (name, email, grade, section, department, birthday, avatar_url, attendance_status) 
VALUES ('Demo Student', 'student@school.com', 10, 'A', 'Science', '2010-01-15', 'https://i.pravatar.cc/150?img=1', 'Present');

-- ============================================
-- 5. Add fee record for demo student
-- ============================================
DO $$
DECLARE
    demo_student_id INTEGER;
BEGIN
    -- Get the ID of the demo student we just created
    SELECT id INTO demo_student_id FROM students WHERE email = 'student@school.com';
    
    -- Add fee record with correct column names (total_fee, paid_amount)
    IF demo_student_id IS NOT NULL THEN
        INSERT INTO student_fees (student_id, total_fee, paid_amount, status, due_date) 
        VALUES (
            demo_student_id, 
            150000,  -- Total fee: ₦150,000
            75000,   -- Paid amount: ₦75,000 (50% paid)
            'Unpaid',
            CURRENT_DATE + INTERVAL '10 days'
        );
    END IF;
END $$;

-- ============================================
-- 6. Verification Queries
-- ============================================
-- Show all students with their emails
SELECT id, name, email, grade, section, department 
FROM students 
ORDER BY id;

-- Verify demo student exists with fee record
SELECT 
    s.id,
    s.name,
    s.email,
    s.grade,
    s.section,
    COALESCE(sf.total_fee, 0) as total_fee,
    COALESCE(sf.paid_amount, 0) as paid_amount,
    COALESCE(sf.status, 'No Fee') as fee_status
FROM students s
LEFT JOIN student_fees sf ON s.id = sf.student_id
WHERE s.email = 'student@school.com';

-- Expected results:
-- 1. All students should have emails
-- 2. Demo Student should exist with email: student@school.com
-- 3. Demo Student should have a fee record: ₦150,000 total, ₦75,000 paid, status 'Unpaid'
-- If you see these, the fix worked! ✅
