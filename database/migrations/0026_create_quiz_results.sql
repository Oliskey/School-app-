

-- 1. Create Quiz Results Table (using quiz_submissions name for consistency)
CREATE TABLE IF NOT EXISTS quiz_submissions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    quiz_id UUID REFERENCES quizzes(id) ON DELETE CASCADE,
    student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
    score INTEGER NOT NULL,
    total_questions INTEGER NOT NULL,
    answers JSONB, -- Stores question_id -> answer_id mapping
    focus_violations INTEGER DEFAULT 0,
    status TEXT DEFAULT 'Graded',
    submitted_at TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);


-- 2. RLS Policies
ALTER TABLE quiz_submissions ENABLE ROW LEVEL SECURITY;

-- Allow students to insert their own results
DROP POLICY IF EXISTS "Students can insert their own quiz results" ON quiz_submissions;
CREATE POLICY "Students can insert their own quiz results"
    ON quiz_submissions FOR INSERT
    WITH CHECK (
        student_id IN (
            SELECT id FROM students WHERE email = auth.jwt() ->> 'email'
        )
    );

-- Allow students to view their own results
DROP POLICY IF EXISTS "Students can view their own quiz results" ON quiz_submissions;
CREATE POLICY "Students can view their own quiz results"
    ON quiz_submissions FOR SELECT
    USING (
        student_id IN (
            SELECT id FROM students WHERE email = auth.jwt() ->> 'email'
        )
    );

-- Allow teachers/admins to view all results
DROP POLICY IF EXISTS "Teachers and Admins can view all quiz results" ON quiz_submissions;
CREATE POLICY "Teachers and Admins can view all quiz results"
    ON quiz_submissions FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM users 
            WHERE email = auth.jwt() ->> 'email' 
            AND role IN ('Teacher', 'Admin', 'Proprietor')
        )
    );
